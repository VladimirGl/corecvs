<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>DeepView: corecvs::KLTGenerator&lt; InterpolationType &gt; Class Template Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">DeepView
   &#160;<span id="projectnumber">0.02</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="namespacecorecvs.html">corecvs</a>      </li>
      <li class="navelem"><a class="el" href="classcorecvs_1_1KLTGenerator.html">KLTGenerator</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-attribs">Public Attributes</a>  </div>
  <div class="headertitle">
<div class="title">corecvs::KLTGenerator&lt; InterpolationType &gt; Class Template Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="corecvs::KLTGenerator" -->
<p><code>#include &lt;<a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>&gt;</code></p>
<div class="dynheader">
Collaboration diagram for corecvs::KLTGenerator&lt; InterpolationType &gt;:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="classcorecvs_1_1KLTGenerator__coll__graph.svg" width="100%" height="239"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<center><span class="legend">[<a href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classcorecvs_1_1KLTGenerator-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#a058b848dd26bbd28817dd4a0d9c60dd4">KLTGenerator</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#a8fdcdd503ba6e10dfd3172e10f4d3331">KLTGenerator</a> (<a class="el" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a> _windowSize, int _newtonIterations=7, int _maxLevels=5)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="classcorecvs_1_1FlowBuffer.html">FlowBuffer</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#a6ccad5db9a878e8d819ed740fa0ad1bf">calculateFlowFromPrevLevelBuffer</a> (<a class="el" href="classcorecvs_1_1G12Buffer.html">G12Buffer</a> *first, <a class="el" href="classcorecvs_1_1G12Buffer.html">G12Buffer</a> *second, <a class="el" href="classcorecvs_1_1FlowBuffer.html">FlowBuffer</a> *prevLevelFlow, bool isHighestFlowBuffer)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="classcorecvs_1_1FlowBuffer.html">FlowBuffer</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#a7255ae22fdab4297f917ac71b2735f07">calculateHierarchicalKLTFlow</a> (<a class="el" href="classcorecvs_1_1G12Buffer.html">G12Buffer</a> *first, <a class="el" href="classcorecvs_1_1G12Buffer.html">G12Buffer</a> *second)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#afdc265cfcab95e8c4bffe4ec42e347b7">kltIteration</a> (const <a class="el" href="classcorecvs_1_1KLTCalculationContext.html">KLTCalculationContext</a> &amp;calculationContext, const <a class="el" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a> &amp;point, <a class="el" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> *startGuess, double nullThreshold) const </td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#ac564dcd7af2129d9299ff96f2922bbbd">kltIterationSubpixel</a> (const <a class="el" href="classcorecvs_1_1KLTCalculationContext.html">KLTCalculationContext</a> &amp;calculationContext, const <a class="el" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> &amp;point, <a class="el" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> *startGuess, double nullThreshold) const </td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#a2a8331689bce4421b17a5b842c5576be">~KLTGenerator</a> ()</td></tr>
<tr><td colspan="2"><h2><a name="pub-attribs"></a>
Public Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#af24f8aee246515148ece4e238cc9bf3a">windowSize</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#a34d1ca6a4203f950e3e035bd797b068a">newtonIterations</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#af495e062732b7f4df662bba2cb47be3a">maxThresholds</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#af601bdb735943724ab9888451e445dd3">minThresholds</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcorecvs_1_1KLTGenerator.html#acb2bc5549b46cd6e174c45f2c7f1a293">maxLevels</a></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><h3>template&lt;typename InterpolationType&gt;<br/>
class corecvs::KLTGenerator&lt; InterpolationType &gt;</h3>


<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00038">38</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>
</div><hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a058b848dd26bbd28817dd4a0d9c60dd4"></a><!-- doxytag: member="corecvs::KLTGenerator::KLTGenerator" ref="a058b848dd26bbd28817dd4a0d9c60dd4" args="()" -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::<a class="el" href="classcorecvs_1_1KLTGenerator.html">KLTGenerator</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00048">48</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>
<div class="fragment"><pre class="fragment">                  :
        <a class="code" href="classcorecvs_1_1KLTGenerator.html#af24f8aee246515148ece4e238cc9bf3a">windowSize</a>(<a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a>(5,5)),
        <a class="code" href="classcorecvs_1_1KLTGenerator.html#a34d1ca6a4203f950e3e035bd797b068a">newtonIterations</a>(7),
        <a class="code" href="classcorecvs_1_1KLTGenerator.html#acb2bc5549b46cd6e174c45f2c7f1a293">maxLevels</a>(5)
    {}
</pre></div>
</div>
</div>
<a class="anchor" id="a8fdcdd503ba6e10dfd3172e10f4d3331"></a><!-- doxytag: member="corecvs::KLTGenerator::KLTGenerator" ref="a8fdcdd503ba6e10dfd3172e10f4d3331" args="(Vector2d32 _windowSize, int _newtonIterations=7, int _maxLevels=5)" -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::<a class="el" href="classcorecvs_1_1KLTGenerator.html">KLTGenerator</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a>&#160;</td>
          <td class="paramname"><em>_windowSize</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>_newtonIterations</em> = <code>7</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>_maxLevels</em> = <code>5</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00053">53</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                        :
        <a class="code" href="classcorecvs_1_1KLTGenerator.html#af24f8aee246515148ece4e238cc9bf3a">windowSize</a>(_windowSize),
        <a class="code" href="classcorecvs_1_1KLTGenerator.html#a34d1ca6a4203f950e3e035bd797b068a">newtonIterations</a>(_newtonIterations),
        <a class="code" href="classcorecvs_1_1KLTGenerator.html#acb2bc5549b46cd6e174c45f2c7f1a293">maxLevels</a>(_maxLevels)
    {}
</pre></div>
</div>
</div>
<a class="anchor" id="a2a8331689bce4421b17a5b842c5576be"></a><!-- doxytag: member="corecvs::KLTGenerator::~KLTGenerator" ref="a2a8331689bce4421b17a5b842c5576be" args="()" -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">virtual <a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::~<a class="el" href="classcorecvs_1_1KLTGenerator.html">KLTGenerator</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00429">429</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>
<div class="fragment"><pre class="fragment">{};
</pre></div>
</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a6ccad5db9a878e8d819ed740fa0ad1bf"></a><!-- doxytag: member="corecvs::KLTGenerator::calculateFlowFromPrevLevelBuffer" ref="a6ccad5db9a878e8d819ed740fa0ad1bf" args="(G12Buffer *first, G12Buffer *second, FlowBuffer *prevLevelFlow, bool isHighestFlowBuffer)" -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classcorecvs_1_1FlowBuffer.html">FlowBuffer</a>* <a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::<a class="el" href="classcorecvs_1_1KLTGenerator.html#a6ccad5db9a878e8d819ed740fa0ad1bf">calculateFlowFromPrevLevelBuffer</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classcorecvs_1_1G12Buffer.html">G12Buffer</a> *&#160;</td>
          <td class="paramname"><em>first</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classcorecvs_1_1G12Buffer.html">G12Buffer</a> *&#160;</td>
          <td class="paramname"><em>second</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classcorecvs_1_1FlowBuffer.html">FlowBuffer</a> *&#160;</td>
          <td class="paramname"><em>prevLevelFlow</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>isHighestFlowBuffer</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00059">59</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>

<p>References <a class="el" href="abstractBuffer_8h_source.html#l00401">corecvs::AbstractBuffer&lt; ElementType, IndexType &gt;::element()</a>, <a class="el" href="kltGenerator_8h_source.html#l00032">corecvs::KLTCalculationContext::first</a>, <a class="el" href="mathUtils_8h_source.html#l00035">corecvs::fround()</a>, <a class="el" href="kltGenerator_8h_source.html#l00034">corecvs::KLTCalculationContext::gradient</a>, <a class="el" href="abstractBuffer_8h_source.html#l00127">corecvs::AbstractBufferParams::h</a>, <a class="el" href="abstractBuffer_8h_source.html#l00443">corecvs::AbstractBuffer&lt; ElementType, IndexType &gt;::hasSameSize()</a>, <a class="el" href="punchedBufferOperations_8h_source.html#l00027">corecvs::PunchedBufferOperations&lt; ThisTypeName, ElementType &gt;::isElementKnownVec()</a>, <a class="el" href="kltGenerator_8h_source.html#l00196">corecvs::KLTGenerator&lt; InterpolationType &gt;::kltIteration()</a>, <a class="el" href="kltGenerator_8h_source.html#l00033">corecvs::KLTCalculationContext::second</a>, <a class="el" href="flowBuffer_8h_source.html#l00100">corecvs::FlowBuffer::setElementUnknown()</a>, <a class="el" href="abstractBuffer_8h_source.html#l00128">corecvs::AbstractBufferParams::w</a>, <a class="el" href="vector2d_8h_source.html#l00050">corecvs::Vector2d&lt; ElementType &gt;::x()</a>, and <a class="el" href="vector2d_8h_source.html#l00055">corecvs::Vector2d&lt; ElementType &gt;::y()</a>.</p>

<p>Referenced by <a class="el" href="kltGenerator_8h_source.html#l00145">corecvs::KLTGenerator&lt; InterpolationType &gt;::calculateHierarchicalKLTFlow()</a>.</p>
<div class="fragment"><pre class="fragment">    {
        <span class="keywordflow">if</span> (!first-&gt;hasSameSize(second))
        {
            <span class="comment">// TODO: Throw exception here</span>
            printf(<span class="stringliteral">&quot;Images have different dimensions \n&quot;</span>);
            <span class="keywordflow">return</span> NULL;
        }

        <span class="keywordflow">if</span> (!isHighestFlowBuffer)
        {
            <span class="keywordflow">if</span> (prevLevelFlow-&gt;hasSameSize(first-&gt;h, first-&gt;w))
            {
                <span class="comment">// TODO: Throw exception here</span>
                printf(<span class="stringliteral">&quot;New flow buffer have wrong dimensions \n&quot;</span>);
                <span class="keywordflow">return</span> NULL;
            }
        }

        <span class="keywordtype">int</span> i,j;

        <span class="keywordtype">double</span> nullThresholdFactor = 1 &lt;&lt; 24;
        <span class="keywordtype">double</span> nullThreshold = 2;
        <span class="keywordtype">int</span> h = first-&gt;h;
        <span class="keywordtype">int</span> w = first-&gt;w;

        FlowBuffer *flow;
        flow = <span class="keyword">new</span> FlowBuffer(h,w);

        <span class="comment">// Yes, this excessively use memory. We should invent something for creating</span>
        <span class="comment">// interface for g12buffer and not lose the performance</span>
        SpatialGradient *sg = <span class="keyword">new</span> SpatialGradient(first);
        <a class="code" href="namespacecorecvs.html#a674fea922c11e614129911399f8536aa">SpatialGradientIntegralBuffer</a> *gradient = <span class="keyword">new</span> <a class="code" href="namespacecorecvs.html#a674fea922c11e614129911399f8536aa">SpatialGradientIntegralBuffer</a>(sg);
        <span class="keyword">delete</span> sg;

        KLTCalculationContext context;
        context.first = first;
        context.second = second;
        context.gradient = gradient;

        <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> g;

        <span class="keywordflow">for</span>(i = 0; i &lt; h; i++)
        {
            <span class="keywordflow">for</span>(j = 0; j &lt; w; j++)
            {
                <a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a> currCoord = <a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a>(j, i);
                <a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a> prevCoord = currCoord / 2;
                <span class="keywordtype">bool</span> status;

                <span class="keywordflow">if</span> (isHighestFlowBuffer)
                {
                    g = <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a>(0.0);
                }
                <span class="keywordflow">else</span>
                {
                    <span class="keywordflow">if</span> (!(prevLevelFlow-&gt;isElementKnownVec(prevCoord)))
                    {
                        <span class="keywordflow">goto</span> flowUnknownLabel;
                    }

                    g = <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a>(prevLevelFlow-&gt;element(prevCoord));
                    g *= 2.0;
                }

                status = <a class="code" href="classcorecvs_1_1KLTGenerator.html#afdc265cfcab95e8c4bffe4ec42e347b7">kltIteration</a>(context, currCoord, &amp;g, nullThreshold * nullThresholdFactor);
                <span class="keywordflow">if</span> (!status)
                    <span class="keywordflow">goto</span> flowUnknownLabel;


                flow-&gt;element(i,j) = <a class="code" href="namespacecorecvs.html#a315502a1c812797ac80b4226f765f371">FlowElement</a>(<a class="code" href="namespacecorecvs.html#a807eb76b7544bcb930b1700a58a780bd" title="Useful round* stuff.">fround</a>(g.x()), <a class="code" href="namespacecorecvs.html#a807eb76b7544bcb930b1700a58a780bd" title="Useful round* stuff.">fround</a>(g.y()));
                <span class="keywordflow">continue</span>;
                flowUnknownLabel:
                     flow-&gt;setElementUnknown(i,j);
             }
        }

        <span class="keyword">delete</span> gradient;
        <span class="keywordflow">return</span> flow;
    }
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="classcorecvs_1_1KLTGenerator_a6ccad5db9a878e8d819ed740fa0ad1bf_cgraph.svg" width="100%" height="384"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
</p>

</div>
</div>
<a class="anchor" id="a7255ae22fdab4297f917ac71b2735f07"></a><!-- doxytag: member="corecvs::KLTGenerator::calculateHierarchicalKLTFlow" ref="a7255ae22fdab4297f917ac71b2735f07" args="(G12Buffer *first, G12Buffer *second)" -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classcorecvs_1_1FlowBuffer.html">FlowBuffer</a>* <a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::<a class="el" href="classcorecvs_1_1KLTGenerator.html#a7255ae22fdab4297f917ac71b2735f07">calculateHierarchicalKLTFlow</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classcorecvs_1_1G12Buffer.html">G12Buffer</a> *&#160;</td>
          <td class="paramname"><em>first</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classcorecvs_1_1G12Buffer.html">G12Buffer</a> *&#160;</td>
          <td class="paramname"><em>second</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00145">145</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>

<p>References <a class="el" href="global_8h_source.html#l00107">ASSERT_TRUE</a>, <a class="el" href="kltGenerator_8h_source.html#l00059">corecvs::KLTGenerator&lt; InterpolationType &gt;::calculateFlowFromPrevLevelBuffer()</a>, <a class="el" href="mipmapPyramid_8h_source.html#l00033">corecvs::AbstractMipmapPyramid&lt; BufferType &gt;::levels</a>, and <a class="el" href="kltGenerator_8h_source.html#l00045">corecvs::KLTGenerator&lt; InterpolationType &gt;::maxLevels</a>.</p>
<div class="fragment"><pre class="fragment">    {
        <a class="code" href="global_8h.html#aa38fef22b6434d04309637be89dac846">ASSERT_TRUE</a>(first  != NULL, <span class="stringliteral">&quot;Arguments should not be null&quot;</span>);
        <a class="code" href="global_8h.html#aa38fef22b6434d04309637be89dac846">ASSERT_TRUE</a>(second != NULL, <span class="stringliteral">&quot;Arguments should not be null&quot;</span>);

        FlowBuffer *prevFlow = NULL;
        FlowBuffer *currentFlow = NULL;
        FlowBuffer *tempFlow = NULL;

        AbstractMipmapPyramid&lt;G12Buffer&gt; *pyramid1 = <span class="keyword">new</span> AbstractMipmapPyramid&lt;G12Buffer&gt; (first, <a class="code" href="classcorecvs_1_1KLTGenerator.html#acb2bc5549b46cd6e174c45f2c7f1a293">maxLevels</a>);
        AbstractMipmapPyramid&lt;G12Buffer&gt; *pyramid2 = <span class="keyword">new</span> AbstractMipmapPyramid&lt;G12Buffer&gt; (second, <a class="code" href="classcorecvs_1_1KLTGenerator.html#acb2bc5549b46cd6e174c45f2c7f1a293">maxLevels</a>);

       <span class="comment">//prevFlow initialization</span>
        prevFlow = <a class="code" href="classcorecvs_1_1KLTGenerator.html#a6ccad5db9a878e8d819ed740fa0ad1bf">calculateFlowFromPrevLevelBuffer</a>(
                    pyramid1-&gt;levels[<a class="code" href="classcorecvs_1_1KLTGenerator.html#acb2bc5549b46cd6e174c45f2c7f1a293">maxLevels</a> - 1],
                    pyramid2-&gt;levels[<a class="code" href="classcorecvs_1_1KLTGenerator.html#acb2bc5549b46cd6e174c45f2c7f1a293">maxLevels</a> - 1],
                    NULL,
                    <span class="keyword">true</span>);

        printf(<span class="stringliteral">&quot;Processing level %d\n&quot;</span>, <a class="code" href="classcorecvs_1_1KLTGenerator.html#acb2bc5549b46cd6e174c45f2c7f1a293">maxLevels</a> - 1);

        <span class="keywordflow">if</span> (<a class="code" href="classcorecvs_1_1KLTGenerator.html#acb2bc5549b46cd6e174c45f2c7f1a293">maxLevels</a> == 1)
            <span class="keywordflow">return</span> prevFlow;

        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l = <a class="code" href="classcorecvs_1_1KLTGenerator.html#acb2bc5549b46cd6e174c45f2c7f1a293">maxLevels</a> - 2;l &gt;= 0;l--)
        {
            tempFlow = prevFlow;

            currentFlow = <a class="code" href="classcorecvs_1_1KLTGenerator.html#a6ccad5db9a878e8d819ed740fa0ad1bf">calculateFlowFromPrevLevelBuffer</a>(
                    pyramid1-&gt;levels[l],
                    pyramid2-&gt;levels[l],
                    prevFlow,
                    <span class="keyword">false</span>);

            <span class="keywordflow">if</span> (l != 0)
                prevFlow = currentFlow;

            printf(<span class="stringliteral">&quot;Processing level %d\n&quot;</span>, l);
            <span class="keyword">delete</span> tempFlow;
        }

        <span class="keyword">delete</span> pyramid1;
        <span class="keyword">delete</span> pyramid2;

        <span class="keywordflow">return</span> currentFlow;

    }
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="classcorecvs_1_1KLTGenerator_a7255ae22fdab4297f917ac71b2735f07_cgraph.svg" width="100%" height="384"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
</p>

</div>
</div>
<a class="anchor" id="afdc265cfcab95e8c4bffe4ec42e347b7"></a><!-- doxytag: member="corecvs::KLTGenerator::kltIteration" ref="afdc265cfcab95e8c4bffe4ec42e347b7" args="(const KLTCalculationContext &amp;calculationContext, const Vector2d32 &amp;point, Vector2dd *startGuess, double nullThreshold) const " -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::<a class="el" href="classcorecvs_1_1KLTGenerator.html#afdc265cfcab95e8c4bffe4ec42e347b7">kltIteration</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classcorecvs_1_1KLTCalculationContext.html">KLTCalculationContext</a> &amp;&#160;</td>
          <td class="paramname"><em>calculationContext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a> &amp;&#160;</td>
          <td class="paramname"><em>point</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> *&#160;</td>
          <td class="paramname"><em>startGuess</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>nullThreshold</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td> const<code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Solve the system Calculating the inverted matrix. <a class="el" href="classcorecvs_1_1Matrix.html">Matrix</a> is symmetrical thus not using standard function</p>

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00196">196</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>

<p>References <a class="el" href="global_8h_source.html#l00107">ASSERT_TRUE</a>, <a class="el" href="global_8h_source.html#l00147">DOTRACE</a>, <a class="el" href="abstractBuffer_8h_source.html#l00401">corecvs::AbstractBuffer&lt; ElementType, IndexType &gt;::element()</a>, <a class="el" href="kltGenerator_8h_source.html#l00032">corecvs::KLTCalculationContext::first</a>, <a class="el" href="mathUtils_8h_source.html#l00035">corecvs::fround()</a>, <a class="el" href="kltGenerator_8h_source.html#l00034">corecvs::KLTCalculationContext::gradient</a>, <a class="el" href="abstractBuffer_8h_source.html#l00127">corecvs::AbstractBufferParams::h</a>, <a class="el" href="abstractContiniousBuffer_8h_source.html#l00276">corecvs::AbstractContiniousBuffer&lt; ElementType, IndexType &gt;::isValidCoordBl()</a>, <a class="el" href="vector2d_8h_source.html#l00156">corecvs::Vector2d&lt; ElementType &gt;::mapToRect()</a>, <a class="el" href="kltGenerator_8h_source.html#l00042">corecvs::KLTGenerator&lt; InterpolationType &gt;::newtonIterations</a>, <a class="el" href="kltGenerator_8h_source.html#l00033">corecvs::KLTCalculationContext::second</a>, <a class="el" href="abstractBuffer_8h_source.html#l00128">corecvs::AbstractBufferParams::w</a>, <a class="el" href="kltGenerator_8h_source.html#l00041">corecvs::KLTGenerator&lt; InterpolationType &gt;::windowSize</a>, <a class="el" href="vector2d_8h_source.html#l00050">corecvs::Vector2d&lt; ElementType &gt;::x()</a>, and <a class="el" href="vector2d_8h_source.html#l00055">corecvs::Vector2d&lt; ElementType &gt;::y()</a>.</p>

<p>Referenced by <a class="el" href="kltGenerator_8h_source.html#l00059">corecvs::KLTGenerator&lt; InterpolationType &gt;::calculateFlowFromPrevLevelBuffer()</a>.</p>
<div class="fragment"><pre class="fragment">    {

        <a class="code" href="global_8h.html#aa38fef22b6434d04309637be89dac846">ASSERT_TRUE</a>(calculationContext.first    != NULL, <span class="stringliteral">&quot;NULL parameter fisrt&quot;</span>);
        <a class="code" href="global_8h.html#aa38fef22b6434d04309637be89dac846">ASSERT_TRUE</a>(calculationContext.second   != NULL, <span class="stringliteral">&quot;NULL parameter second&quot;</span>);
        <a class="code" href="global_8h.html#aa38fef22b6434d04309637be89dac846">ASSERT_TRUE</a>(calculationContext.gradient != NULL, <span class="stringliteral">&quot;NULL parameter gradient&quot;</span>);
        G12Buffer *first  = calculationContext.first;
        G12Buffer *second = calculationContext.second;

        <a class="code" href="stdint__win_8h.html#a6eb1e68cc391dd753bc8ce896dbb8315">uint32_t</a> h = first-&gt;h;
        <a class="code" href="stdint__win_8h.html#a6eb1e68cc391dd753bc8ce896dbb8315">uint32_t</a> w = first-&gt;w;

        <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> currentGuess = *startGuess;

        <span class="comment">/* We use iterative method and stop if number of iterations is above the threshold*/</span>
        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l = 0;l &lt; <a class="code" href="classcorecvs_1_1KLTGenerator.html#a34d1ca6a4203f950e3e035bd797b068a">newtonIterations</a>; l++)
        {
            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;Starting iteration %d\n&quot;</span>, l));
            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\tEntering guess: [%lf %lf]\n&quot;</span>, currentGuess.x(), currentGuess.y()));

            <span class="comment">/* The integer position in the other image */</span>
            <a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a> prediction( <a class="code" href="namespacecorecvs.html#a807eb76b7544bcb930b1700a58a780bd" title="Useful round* stuff.">fround</a>(point.x() + currentGuess.x()),
                                   <a class="code" href="namespacecorecvs.html#a807eb76b7544bcb930b1700a58a780bd" title="Useful round* stuff.">fround</a>(point.y() + currentGuess.y()));

            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\tPreditiction (%d %d)\n&quot;</span>, prediction.x(), prediction.y()));


            <span class="comment">/* If we hit outside the second image we should give up*/</span>
            <span class="comment">/*if (! second-&gt;isValidCoord(prediction - windowSize - Vector2d32(2,2)) ||</span>
<span class="comment">                ! second-&gt;isValidCoord(prediction + windowSize + Vector2d32(2,2)))</span>
<span class="comment">                return false;*/</span>

            <a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a> low  = point - <a class="code" href="classcorecvs_1_1KLTGenerator.html#af24f8aee246515148ece4e238cc9bf3a">windowSize</a>;
            <a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a> high = point + <a class="code" href="classcorecvs_1_1KLTGenerator.html#af24f8aee246515148ece4e238cc9bf3a">windowSize</a>;
            low.<a class="code" href="classcorecvs_1_1Vector2d.html#a71d8f2e3266a2bcd8740c2aaf774b9ee">mapToRect</a>(<a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a>(0,0), <a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a>(w - 1, h - 1));
            high.mapToRect(<a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a>(0,0), <a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a>(w - 1, h - 1));

            <span class="keywordtype">int</span> x0 =  low.x();
            <span class="keywordtype">int</span> y0 =  low.y();
            <span class="keywordtype">int</span> x1 = high.x();
            <span class="keywordtype">int</span> y1 = high.y();

            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\tWorking zone (%d %d)x(%d %d)\n&quot;</span>, x0, y0, x1, y1));

    <span class="comment">//        Vector3dd mSG = calculationContext.gradient-&gt;rectangle(x0,y0,x1,y1);</span>
    <span class="comment">//        DOTRACE((&quot;\tG matrix:\n&quot;));</span>
    <span class="comment">//        DOTRACE((&quot;\t[%lf %lf]\n&quot;, mSG.x(), mSG.y()));</span>
    <span class="comment">//        DOTRACE((&quot;\t[%lf %lf]\n&quot;, mSG.y(), mSG.z()));</span>

<span class="comment"></span>
<span class="comment">            /**</span>
<span class="comment">             *  Solve the system</span>
<span class="comment">             *  Calculating the inverted matrix. Matrix is symmetrical thus not using standard function</span>
<span class="comment">             *</span>
<span class="comment">             * */</span>
    <span class="comment">//        double det = mSG.x() * mSG.z() - mSG.y() * mSG.y();</span>

    <span class="comment">//        if (fabs(det) &lt; nullThreshold)</span>
    <span class="comment">//            return false;</span>

    <span class="comment">//        double inv11 =  mSG.z() / det;</span>
    <span class="comment">//        double inv12 = -mSG.y() / det;</span>
    <span class="comment">//        double inv22 =  mSG.x() / det;</span>

            <span class="comment">//calculating mismatch vector</span>
            <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> b = <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a>(0.0);
            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\n&quot;</span>));
            <span class="keywordtype">double</span> sum11 = 0;
            <span class="keywordtype">double</span> sum12 = 0;
            <span class="keywordtype">double</span> sum22 = 0;
            <a class="code" href="namespaceInterpolationType.html#ab9beab1dfc0ec136a7273b69650207ff" title="InterpolationType InterpolationType.">InterpolationType</a> interpolator;
            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = y0; i &lt;= y1; i++)
            {
                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = x0; j &lt;= x1; j++)
                {
                    <span class="keywordtype">double</span> targetX = j + currentGuess.x();
                    <span class="keywordtype">double</span> targetY = i + currentGuess.y();

                    <span class="keywordflow">if</span> (!second-&gt;isValidCoordBl(targetY, targetX))
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;

                    <span class="keywordtype">double</span> dI = (double)first -&gt;element  (i      , j      ) -
                                        interpolator.interpolate(targetY, targetX, second);

                    <span class="keywordtype">double</span> Ix = (double)(
                            first-&gt;element(i, j + 1) -
                            first-&gt;element(i, j - 1)
                            ) / 2.0;
                    <span class="keywordtype">double</span> Iy = (double)(
                            first-&gt;element(i + 1, j) -
                            first-&gt;element(i - 1, j)
                            ) / 2.0;
                    <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;%d %d ( %lf %lf %lf) &quot;</span>, i, j, dI, Ix, Iy));

                    sum11 += Ix * Ix;
                    sum22 += Iy * Iy;
                    sum12 += Iy * Ix;
                    b += <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a>(Ix, Iy) * dI;
                }
            }
            <span class="keywordtype">double</span> det = sum11 * sum22 - sum12 * sum12;

            <span class="keywordflow">if</span> (fabs(det) &lt; nullThreshold)
                <span class="keywordflow">return</span> <span class="keyword">false</span>;

            <span class="keywordtype">double</span> inv11 =  sum22 / det;
            <span class="keywordtype">double</span> inv12 = -sum12 / det;
            <span class="keywordtype">double</span> inv22 =  sum11 / det;

            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\n&quot;</span>));
            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\tB vector (%lf %lf)\n&quot;</span>, b.x(), b.y()));
            <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> t = <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a>( inv11 * b.x() + inv12 * b.y(), inv12 * b.x() + inv22 * b.y());
            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\tT vector (%lf %lf)\n&quot;</span>, t.x(), t.y()));

            currentGuess += t;
         }

        <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;Correcton %lf\n&quot;</span>, !((*startGuess) - currentGuess)));
        *startGuess = currentGuess;
        <span class="keywordflow">return</span> <span class="keyword">true</span>;

    };
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="classcorecvs_1_1KLTGenerator_afdc265cfcab95e8c4bffe4ec42e347b7_cgraph.svg" width="635" height="307"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac564dcd7af2129d9299ff96f2922bbbd"></a><!-- doxytag: member="corecvs::KLTGenerator::kltIterationSubpixel" ref="ac564dcd7af2129d9299ff96f2922bbbd" args="(const KLTCalculationContext &amp;calculationContext, const Vector2dd &amp;point, Vector2dd *startGuess, double nullThreshold) const " -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::<a class="el" href="classcorecvs_1_1KLTGenerator.html#ac564dcd7af2129d9299ff96f2922bbbd">kltIterationSubpixel</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classcorecvs_1_1KLTCalculationContext.html">KLTCalculationContext</a> &amp;&#160;</td>
          <td class="paramname"><em>calculationContext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> &amp;&#160;</td>
          <td class="paramname"><em>point</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> *&#160;</td>
          <td class="paramname"><em>startGuess</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>nullThreshold</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td> const<code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00323">323</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>

<p>References <a class="el" href="global_8h_source.html#l00107">ASSERT_TRUE</a>, <a class="el" href="global_8h_source.html#l00147">DOTRACE</a>, <a class="el" href="kltGenerator_8h_source.html#l00032">corecvs::KLTCalculationContext::first</a>, <a class="el" href="kltGenerator_8h_source.html#l00034">corecvs::KLTCalculationContext::gradient</a>, <a class="el" href="abstractBuffer_8h_source.html#l00127">corecvs::AbstractBufferParams::h</a>, <a class="el" href="abstractBuffer_8h_source.html#l00427">corecvs::AbstractBuffer&lt; ElementType, IndexType &gt;::isValidCoord()</a>, <a class="el" href="kltGenerator_8h_source.html#l00042">corecvs::KLTGenerator&lt; InterpolationType &gt;::newtonIterations</a>, <a class="el" href="kltGenerator_8h_source.html#l00033">corecvs::KLTCalculationContext::second</a>, <a class="el" href="abstractBuffer_8h_source.html#l00128">corecvs::AbstractBufferParams::w</a>, <a class="el" href="kltGenerator_8h_source.html#l00041">corecvs::KLTGenerator&lt; InterpolationType &gt;::windowSize</a>, <a class="el" href="vector2d_8h_source.html#l00050">corecvs::Vector2d&lt; ElementType &gt;::x()</a>, <a class="el" href="vector3d_8h_source.html#l00052">corecvs::Vector3d&lt; ElementType &gt;::x()</a>, <a class="el" href="vector2d_8h_source.html#l00055">corecvs::Vector2d&lt; ElementType &gt;::y()</a>, <a class="el" href="vector3d_8h_source.html#l00057">corecvs::Vector3d&lt; ElementType &gt;::y()</a>, and <a class="el" href="vector3d_8h_source.html#l00062">corecvs::Vector3d&lt; ElementType &gt;::z()</a>.</p>

<p>Referenced by <a class="el" href="correspondanceList_8cpp_source.html#l00173">corecvs::CorrespondanceList::makePrecise()</a>, and <a class="el" href="correspondanceList_8cpp_source.html#l00133">corecvs::CorrespondanceList::makePreciseCopy()</a>.</p>
<div class="fragment"><pre class="fragment">    {

        <a class="code" href="global_8h.html#aa38fef22b6434d04309637be89dac846">ASSERT_TRUE</a>(calculationContext.first    != NULL, <span class="stringliteral">&quot;NULL parameter fisrt&quot;</span>);
        <a class="code" href="global_8h.html#aa38fef22b6434d04309637be89dac846">ASSERT_TRUE</a>(calculationContext.second   != NULL, <span class="stringliteral">&quot;NULL parameter second&quot;</span>);
        <a class="code" href="global_8h.html#aa38fef22b6434d04309637be89dac846">ASSERT_TRUE</a>(calculationContext.gradient != NULL, <span class="stringliteral">&quot;NULL parameter gradient&quot;</span>);
        G12Buffer *first  = calculationContext.first;
        G12Buffer *second = calculationContext.second;

    <span class="comment">//    uint32_t h = first-&gt;h;</span>
    <span class="comment">//    uint32_t w = first-&gt;w;</span>

        <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> currentGuess = *startGuess;

        <span class="comment">/* We use iterative method and stop if number of iterations is above the threshold*/</span>
        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> l = 0; l &lt; <a class="code" href="classcorecvs_1_1KLTGenerator.html#a34d1ca6a4203f950e3e035bd797b068a">newtonIterations</a>; l++)
        {
            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;Starting iteration %d\n&quot;</span>, l));
            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\tEntering point: [%lf %lf]\n&quot;</span>, point.x(), point.y()));
            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\tEntering guess: [%lf %lf]\n&quot;</span>, currentGuess.x(), currentGuess.y()));
            <span class="comment">/* The position in the other image */</span>
            <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> prediction = point + currentGuess;
            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\tPreditiction (%lf %lf)\n&quot;</span>, prediction.x(), prediction.y()));


            <span class="comment">/* If we hit outside the second image we should give up*/</span>
            <span class="keywordflow">if</span> (!calculationContext.second-&gt;isValidCoord(<a class="code" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a>(prediction)))
                <span class="keywordflow">return</span> <span class="keyword">false</span>;

            <span class="comment">//Vector2dd low  = point - Vector2dd(windowSize);</span>
            <span class="comment">//Vector2dd high = point + Vector2dd(windowSize);</span>
            <span class="comment">//low.mapToRect(Vector2dd(0,0), Vector2dd(w - 1, h - 1));</span>
            <span class="comment">//high.mapToRect(Vector2dd(0,0), Vector2dd(w - 1, h - 1));</span>

            <span class="comment">//int x0 =  low.x();</span>
            <span class="comment">//int y0 =  low.y();</span>
            <span class="comment">//int x1 = high.x();</span>
            <span class="comment">//int y1 = high.y();</span>

            <span class="comment">//DOTRACE((&quot;\tWorking zone (%d %d)x(%d %d)\n&quot;, x0, y0, x1, y0));</span>

            <span class="comment">/*</span>
<span class="comment">            Vector3dd mSG = calculationContext.gradient-&gt;rectangle(y0,x0,y1,x1);</span>
<span class="comment">            DOTRACE((&quot;\tG matrix:\n&quot;));</span>
<span class="comment">            DOTRACE((&quot;\t[%lf %lf]\n&quot;, mSG.x(), mSG.y()));</span>
<span class="comment">            DOTRACE((&quot;\t[%lf %lf]\n&quot;, mSG.y(), mSG.z()));</span>
<span class="comment">    */</span>

            <span class="comment">//calculating mismatch vector</span>
            <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> b = <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a>(0.0);
            <a class="code" href="namespacecorecvs.html#a8c6504d3d8b574bfb908b9fe5a7a3974">Vector3dd</a> mSG = <a class="code" href="namespacecorecvs.html#a8c6504d3d8b574bfb908b9fe5a7a3974">Vector3dd</a>(0.0);

            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\n&quot;</span>));

            <a class="code" href="namespaceInterpolationType.html#ab9beab1dfc0ec136a7273b69650207ff" title="InterpolationType InterpolationType.">InterpolationType</a> interpolator;
            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -<a class="code" href="classcorecvs_1_1KLTGenerator.html#af24f8aee246515148ece4e238cc9bf3a">windowSize</a>.<a class="code" href="classcorecvs_1_1Vector2d.html#ae1ea2ad4c0821001408bf963cffa8413">y</a>(); i &lt;= <a class="code" href="classcorecvs_1_1KLTGenerator.html#af24f8aee246515148ece4e238cc9bf3a">windowSize</a>.<a class="code" href="classcorecvs_1_1Vector2d.html#ae1ea2ad4c0821001408bf963cffa8413">y</a>(); i++)
            {
                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = -<a class="code" href="classcorecvs_1_1KLTGenerator.html#af24f8aee246515148ece4e238cc9bf3a">windowSize</a>.<a class="code" href="classcorecvs_1_1Vector2d.html#a944721c41f044c1388d9dc42ca899bce">x</a>(); j &lt;= <a class="code" href="classcorecvs_1_1KLTGenerator.html#af24f8aee246515148ece4e238cc9bf3a">windowSize</a>.<a class="code" href="classcorecvs_1_1Vector2d.html#a944721c41f044c1388d9dc42ca899bce">x</a>(); j++)
                {
                    <span class="keywordtype">double</span> x =  point.x() + (double)j;
                    <span class="keywordtype">double</span> y =  point.y() + (double)i;

                    <span class="keywordtype">double</span> dI = interpolator.interpolate(y, x, first) -
                                interpolator.interpolate(y + currentGuess.y(), x + currentGuess.x(), second);

                    <span class="keywordtype">double</span> Ix = (double)(
                            interpolator.interpolate(y      , min(first-&gt;w - 1.0, x + 1.0), first) -
                            interpolator.interpolate(y      , max(0.0, x - 1.0), first)
                                ) / (min(first-&gt;w - 1.0, x + 1.0) - max(0.0, x - 1.0));

                    <span class="keywordtype">double</span> Iy = (double)(
                                interpolator.interpolate(min(first-&gt;h - 1.0, y + 1.0), x, first) -
                            interpolator.interpolate(max(0.0, y - 1.0), x, first)
                                ) / (min(first-&gt;h - 1.0, y) - max(0.0, y - 1.0));
                    <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;%d %d ( %lf %lf %lf)\n&quot;</span>, i, j, dI, Ix, Iy));

                    mSG += <a class="code" href="namespacecorecvs.html#a8c6504d3d8b574bfb908b9fe5a7a3974">Vector3dd</a>(Ix * Ix, Ix * Iy, Iy * Iy);
                    b += <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a>(Ix, Iy) * dI;
                }
            }

            <span class="keywordtype">double</span> det = mSG.<a class="code" href="classcorecvs_1_1Vector2d.html#a944721c41f044c1388d9dc42ca899bce">x</a>() * mSG.z() - mSG.y() * mSG.y();

            <span class="keywordflow">if</span> (fabs(det) &lt; nullThreshold)
                <span class="keywordflow">return</span> <span class="keyword">false</span>;

            <span class="keywordtype">double</span> inv11 =  mSG.z() / det;
            <span class="keywordtype">double</span> inv12 = -mSG.y() / det;
            <span class="keywordtype">double</span> inv22 =  mSG.x() / det;

            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\n&quot;</span>));
            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\tB vector (%lf %lf)\n&quot;</span>, b.x(), b.y()));
            <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a> t = <a class="code" href="namespacecorecvs.html#af76dfccc4f8b3f0a802cc2dd27a3b303">Vector2dd</a>( inv11 * b.x() + inv12 * b.y(), inv12 * b.x() + inv22 * b.y());
            <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;\tT vector (%lf %lf)\n&quot;</span>, t.x(), t.y()));

            currentGuess += t;
         }

        <a class="code" href="global_8h.html#a8fc171473e59dec1134d86647268481f" title="TODO: Add flush.">DOTRACE</a>((<span class="stringliteral">&quot;Correcton %lf\n&quot;</span>, !((*startGuess) - currentGuess)));
        *startGuess = currentGuess;
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
    }
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="classcorecvs_1_1KLTGenerator_ac564dcd7af2129d9299ff96f2922bbbd_cgraph.svg" width="614" height="307"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
</p>

</div>
</div>
<hr/><h2>Member Data Documentation</h2>
<a class="anchor" id="acb2bc5549b46cd6e174c45f2c7f1a293"></a><!-- doxytag: member="corecvs::KLTGenerator::maxLevels" ref="acb2bc5549b46cd6e174c45f2c7f1a293" args="" -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::<a class="el" href="classcorecvs_1_1KLTGenerator.html#acb2bc5549b46cd6e174c45f2c7f1a293">maxLevels</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00045">45</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>

<p>Referenced by <a class="el" href="kltGenerator_8h_source.html#l00145">corecvs::KLTGenerator&lt; InterpolationType &gt;::calculateHierarchicalKLTFlow()</a>.</p>

</div>
</div>
<a class="anchor" id="af495e062732b7f4df662bba2cb47be3a"></a><!-- doxytag: member="corecvs::KLTGenerator::maxThresholds" ref="af495e062732b7f4df662bba2cb47be3a" args="" -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">double* <a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::<a class="el" href="classcorecvs_1_1KLTGenerator.html#af495e062732b7f4df662bba2cb47be3a">maxThresholds</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00043">43</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>

</div>
</div>
<a class="anchor" id="af601bdb735943724ab9888451e445dd3"></a><!-- doxytag: member="corecvs::KLTGenerator::minThresholds" ref="af601bdb735943724ab9888451e445dd3" args="" -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">double* <a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::<a class="el" href="classcorecvs_1_1KLTGenerator.html#af601bdb735943724ab9888451e445dd3">minThresholds</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00044">44</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>

</div>
</div>
<a class="anchor" id="a34d1ca6a4203f950e3e035bd797b068a"></a><!-- doxytag: member="corecvs::KLTGenerator::newtonIterations" ref="a34d1ca6a4203f950e3e035bd797b068a" args="" -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::<a class="el" href="classcorecvs_1_1KLTGenerator.html#a34d1ca6a4203f950e3e035bd797b068a">newtonIterations</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00042">42</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>

<p>Referenced by <a class="el" href="kltGenerator_8h_source.html#l00196">corecvs::KLTGenerator&lt; InterpolationType &gt;::kltIteration()</a>, and <a class="el" href="kltGenerator_8h_source.html#l00323">corecvs::KLTGenerator&lt; InterpolationType &gt;::kltIterationSubpixel()</a>.</p>

</div>
</div>
<a class="anchor" id="af24f8aee246515148ece4e238cc9bf3a"></a><!-- doxytag: member="corecvs::KLTGenerator::windowSize" ref="af24f8aee246515148ece4e238cc9bf3a" args="" -->
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename InterpolationType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="namespacecorecvs.html#aee6f3bc6f4b08d8c01da863541eab544">Vector2d32</a> <a class="el" href="classcorecvs_1_1KLTGenerator.html">corecvs::KLTGenerator</a>&lt; InterpolationType &gt;::<a class="el" href="classcorecvs_1_1KLTGenerator.html#af24f8aee246515148ece4e238cc9bf3a">windowSize</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="kltGenerator_8h_source.html#l00041">41</a> of file <a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a>.</p>

<p>Referenced by <a class="el" href="kltGenerator_8h_source.html#l00196">corecvs::KLTGenerator&lt; InterpolationType &gt;::kltIteration()</a>, and <a class="el" href="kltGenerator_8h_source.html#l00323">corecvs::KLTGenerator&lt; InterpolationType &gt;::kltIterationSubpixel()</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>core/kltflow/<a class="el" href="kltGenerator_8h_source.html">kltGenerator.h</a></li>
</ul>
</div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Tue Nov 12 2013 23:44:54 for DeepView by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
