<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>DeepView: core/automotive/FCostFunction.cpp File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">DeepView
   &#160;<span id="projectnumber">0.02</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#namespaces">Namespaces</a>  </div>
  <div class="headertitle">
<div class="title">core/automotive/FCostFunction.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>This file holds implementation of functions for compensated flow cost function.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="FCostFunction_8h_source.html">FCostFunction.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="matrix44_8h_source.html">matrix44.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="eulerAngles_8h_source.html">eulerAngles.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for FCostFunction.cpp:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="FCostFunction_8cpp__incl.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
</div>
<p><a href="FCostFunction_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="namespaces"></a>
Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacecorecvs.html">corecvs</a></td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight"><p>Design is heavily based on <a href="http://glorfindel.mavrinac.com/~aaron/school/pdf/prescott97_linelens.pdf">http://glorfindel.mavrinac.com/~aaron/school/pdf/prescott97_linelens.pdf</a>. </p>
<br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>This file holds implementation of functions for compensated flow cost function. </p>
<dl class="date"><dt><b>Date:</b></dt><dd>Feb 6, 2011 </dd></dl>
<dl class="author"><dt><b>Author:</b></dt><dd>alexander</dd></dl>
<h2>Fu function structure </h2>
<p>We have a 3D feature </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ m = (x, y, z, 1)^T \]" src="form_4.png"/>
</p>
<p> World to camera matrix M </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ M_{4,4} = R_a R_b R_c\]" src="form_5.png"/>
</p>
<p>There are 3 coordinate systems types with</p>
<p>1. Car system - connected to the center of the mass of the car </p>
<ul>
<li>
<img class="formulaInl" alt="$OX$" src="form_6.png"/> -reverse of car forward movement  </li>
<li>
<img class="formulaInl" alt="$OY$" src="form_7.png"/> -goes right from car  </li>
<li>
<img class="formulaInl" alt="$OZ$" src="form_8.png"/> -orthogonal, goes up into the air </li>
</ul>
<p>2. Camera system with car axis orientation but it's origin is connected with camera optical center</p>
<p>3. And the third one is the camera system (in fact 4 of them) that is connected with each cameras top left point of the image </p>
<ul>
<li>
<img class="formulaInl" alt="$OX$" src="form_6.png"/> -to the right of the image (from top left to the top right corner) </li>
<li>
<img class="formulaInl" alt="$OY$" src="form_7.png"/> -downwards (from top left to the bottom left corner) </li>
<li>
<img class="formulaInl" alt="$OZ$" src="form_8.png"/> -orthogonal, goes from the camera into the scene </li>
</ul>
<p>The transformation from the 2nd to the 3rd system is denoted by the matrix <img class="formulaInl" alt="$R_{camera}$" src="form_9.png"/></p>
<p>So rotation matrixes are <img class="formulaInl" alt="$Rc=R_{yaw}, Rb = R_{pitch}, Ra = R_{roll}$" src="form_10.png"/></p>
<p>Translation matrix is</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ T_{camera} = \pmatrix{ 1 &amp; 0 &amp; 0 &amp; tx_{camera} \cr 0 &amp; 1 &amp; 0 &amp; ty_{camera} \cr 0 &amp; 0 &amp; 1 &amp; tz_{camera} \cr 0 &amp; 0 &amp; 0 &amp; 1 }\]" src="form_11.png"/>
</p>
<p>Then M matrix will be</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ M_{4,4} = R_c(\alpha_{yaw}) R_b(\alpha_{pitch}) R_a(\alpha_{roll}) R_{camera} T_{camera}\]" src="form_12.png"/>
</p>
<p>As car moves - the m moves relative to car system of coordinates. This movement is denoted by the Matrix: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ A_{4,4}(t) \]" src="form_13.png"/>
</p>
<p>A can be constructed as the product of the car translation matrix -</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ T_{car} = \pmatrix{ 1 &amp; 0 &amp; 0 &amp; tx_{car} \cr 0 &amp; 1 &amp; 0 &amp; ty_{car} \cr 0 &amp; 0 &amp; 1 &amp; tz_{car} \cr 0 &amp; 0 &amp; 0 &amp; 1 }\]" src="form_14.png"/>
</p>
<p>and car rotation matrix</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ R_{car} = R_c(\alpha_{frame yaw}) R_b(\alpha_{frame pitch}) R_a(\alpha_{frame roll}) \]" src="form_15.png"/>
</p>
<p>So A will be</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ A(1) = R_{car} T_{car} \]" src="form_16.png"/>
</p>
<p>Camera intrinsics scale and shift the image. Denoting camera scaler as <img class="formulaInl" alt="$f = \frac {F_{Focal Length}} {K_{Pixel Size}}$" src="form_17.png"/> and camera image center as <img class="formulaInl" alt="$(I_x, I_y)$" src="form_18.png"/> we can write the connection between the image coordinates and the camera coordinates. We will denote it by matrix <img class="formulaInl" alt="$K$" src="form_19.png"/></p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[K = \pmatrix{ f \over k &amp; 0 &amp; I_x &amp; 0 \cr 0 &amp; f \over k &amp; I_y &amp; 0 \cr 0 &amp; 0 &amp; 1 &amp; 0 \cr 0 &amp; 0 &amp; 0 &amp; 1 }\]" src="form_20.png"/>
</p>
<p>We now have the position of the <img class="formulaInl" alt="$m$" src="form_21.png"/> how it is visible from the camera coordinate system in the moment 0 and 1 </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ q_0 = K M m\]" src="form_22.png"/>
</p>
 <p class="formulaDsp">
<img class="formulaDsp" alt="\[ q_1 = K M A(1) m\]" src="form_23.png"/>
</p>
<p>For simplification we will denote</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ D = K M \]" src="form_24.png"/>
</p>
<p>So <img class="formulaInl" alt="$q_1, q_0$" src="form_25.png"/> are connected with the following equation </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ q_1 = D A(1) D^{-1} q_0 \]" src="form_26.png"/>
</p>
<p>As <img class="formulaInl" alt="$K$" src="form_19.png"/> and <img class="formulaInl" alt="$M$" src="form_27.png"/> both have very simple structure the analytical inversion is trivial. Now let's denote vector components the following way</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ q_0 = (u_0 d_0, v_0 d_0, d_0, 1) \]" src="form_28.png"/>
</p>
 <p class="formulaDsp">
<img class="formulaDsp" alt="\[ q_1 = (u_1 d_1, v_1 d_1, d_1, 1) \]" src="form_29.png"/>
</p>
<p>Time give up <img class="formulaInl" alt="$m$" src="form_21.png"/> and study</p>
<p>the <img class="formulaInl" alt="$q_i$" src="form_30.png"/> evolution</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ B_{4,4} = D A(1) D^{-1} \]" src="form_31.png"/>
</p>
 <p class="formulaDsp">
<img class="formulaDsp" alt="\[ q_1 = B q_0 \]" src="form_32.png"/>
</p>
 <p class="formulaDsp">
<img class="formulaDsp" alt="\[ (u_1 d_1, v_1 d_1, d_1, 1) = B (u_0 d_0, v_0 d_0, d_0, 1)^T \]" src="form_33.png"/>
</p>
<p>Let's now introduce the notation for elements of B</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ B = \pmatrix{ b_{0,0} &amp; b_{0,1} &amp; b_{0,2} &amp; b_{0,3}\cr b_{1,0} &amp; b_{1,1} &amp; b_{1,2} &amp; b_{1,3}\cr b_{2,0} &amp; b_{2,1} &amp; b_{2,2} &amp; b_{2,3}\cr 0 &amp; 0 &amp; 0 &amp; 1 } = \left( \begin{array}{cccc} \multicolumn{4}{c}{B_u} \\ \multicolumn{4}{c}{B_v} \\ \multicolumn{4}{c}{B_w} \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{array} \right) \]" src="form_34.png"/>
</p>
<p>rewriting the matrix form into element one</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} u_1 d_1 &amp;=&amp; b_{00} u_0 d_0 + b_{01} v_0 d_0 + b_{02} d_0 + b_{03} \\ v_1 d_1 &amp;=&amp; b_{10} u_0 d_0 + b_{11} v_0 d_0 + b_{12} d_0 + b_{13} \\ d_1 &amp;=&amp; b_{20} u_0 d_0 + b_{21} v_0 d_0 + b_{22} d_0 + b_{23} \end{eqnarray*}" src="form_35.png"/>
</p>
<p>Introducing the substitutions independent from <img class="formulaInl" alt="$d_0$" src="form_36.png"/> and <img class="formulaInl" alt="$d_1$" src="form_37.png"/></p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} T_u &amp;=&amp; b_{00} u_0 + b_{01} v_0 + b_{02} \\ T_v &amp;=&amp; b_{10} u_0 + b_{11} v_0 + b_{12} \\ T_w &amp;=&amp; b_{20} u_0 + b_{21} v_0 + b_{22} \end{eqnarray*}" src="form_38.png"/>
</p>
<p>With this we can rewrite the equations to :</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray} u_1 d_1 &amp;=&amp; T_u d_0 + b_{03} \\ v_1 d_1 &amp;=&amp; T_v d_0 + b_{13} \\ d_1 &amp;=&amp; T_w d_0 + b_{23} \end{eqnarray}" src="form_39.png"/>
</p>
<h3>Forward and Backward camera </h3>
<p>We now want to get rid of <img class="formulaInl" alt="$d_0$" src="form_36.png"/> and <img class="formulaInl" alt="$d_1$" src="form_37.png"/> completely, for this we substitute <img class="formulaInl" alt="$(3)$" src="form_40.png"/> into <img class="formulaInl" alt="$(2)$" src="form_41.png"/></p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} v_1 (T_w d_0 + b_{23}) &amp;=&amp; T_v d_0 + b_{13} \\ (v_1 T_w - T_v) d_0 &amp;=&amp; b_{13} - v_1 b_{23} \\ d0 &amp;=&amp; - \frac {b_{23} v_1 - b_{13}} {T_w v_1 - T_v} \label{D0v} \end{eqnarray*}" src="form_42.png"/>
</p>
<h3>Left and Right side camera </h3>
<p>Equation differs for side view cameras</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} d0 &amp;=&amp; - \frac {b_{23} v_1 - b_{03}} {T_w u_1 - T_u} \label{D1v} \end{eqnarray*}" src="form_43.png"/>
</p>
<p>In case of a still standing car, it could happen that d0 will be undefined because the denominator of the equation will be equal to zero. In this case take any positive value as d0.</p>
<p>Introducing former into the equation <img class="formulaInl" alt="$(3)$" src="form_40.png"/> leads to the distance d1</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ d_1 = d_0 T_w + b_{23} \]" src="form_44.png"/>
</p>
<p>Putting <img class="formulaInl" alt="$d_0$" src="form_36.png"/> and <img class="formulaInl" alt="$d_1$" src="form_37.png"/> into equations <img class="formulaInl" alt="$(1)$" src="form_45.png"/> into <img class="formulaInl" alt="$(2)$" src="form_41.png"/> results into the functions</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} b_{00} u_0 d_0 + b_{01} v_0 d_0 + b_{02} d_0 + b_{03} - u_1 d_1 = 0 \\ F_u() = u_1 - {\frac {1} {d_1}} (T_u d_0 + b_{14}) = 0 \end{eqnarray*}" src="form_46.png"/>
</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} b_{10} u_0 d_0 + b_{11} v_0 d_0 + b_{12} d_0 + b_{23} - v_1 d_1 = 0 \\ F_v() = v_1 - {\frac {1} {d_1}} (T_v d_0 + b_{13}) = 0 \end{eqnarray*}" src="form_47.png"/>
</p>
<p>In the previous equation, in case <img class="formulaInl" alt="$(u_1,v_1)$" src="form_48.png"/> is really the image of <img class="formulaInl" alt="$(u_0,v_0)$" src="form_49.png"/> and camera parameters are precise. <img class="formulaInl" alt="$F_u$" src="form_50.png"/> and <img class="formulaInl" alt="$F_v$" src="form_51.png"/> should both be zero. In reality if we will be able to find model parameters that makes all <img class="formulaInl" alt="$F_u$" src="form_50.png"/> and <img class="formulaInl" alt="$F_v$" src="form_51.png"/> be zero - we have found a correct model.</p>
<p>Also we are able to build Jacobian for Kalman filter</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ C = \pmatrix{ \frac {\delta F} {\delta \alpha_{yaw}} \cr \frac {\delta F} {\delta \alpha_{pitch}} \cr \frac {\delta F} {\delta C_{Road Curvature}} } \]" src="form_52.png"/>
</p>
<h2>Some additional Math </h2>
<p>Formulas above give us the information about the actual depth of the object if we know car speed and visa versa. Knowing speed is a common situation, and thus we can guess depth.</p>
<p>Using <img class="formulaInl" alt="$ d_1 $" src="form_53.png"/> derived form known matrices we can compute</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ q_1 = (u_1 d_1, v_1 d_1, d_1, 1) \]" src="form_29.png"/>
</p>
<p>And then <img class="formulaInl" alt="$ q_1 = K M m_1 = D m_1$" src="form_54.png"/> , where m_1 = A(1) m</p>
<p>So current position <img class="formulaInl" alt="$ m_1$" src="form_55.png"/> could be computed as</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ m_1 = D^{-1} q_1 \]" src="form_56.png"/>
</p>
 
<p>Definition in file <a class="el" href="FCostFunction_8cpp_source.html">FCostFunction.cpp</a>.</p>
</div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Tue Nov 12 2013 23:44:39 for DeepView by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
